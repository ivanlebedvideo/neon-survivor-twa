<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Survivor TWA</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: sans-serif; overflow: hidden; touch-action: none; }
        #ui { position: absolute; top: 10px; left: 10px; z-index: 10; pointer-events: none; }
        .stat { font-size: 14px; color: #4ecca3; text-shadow: 0 0 5px #000; }
        
        #menu { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            background: rgba(0,0,0,0.95); z-index: 100; padding: 20px; box-sizing: border-box;
        }
        .menu-box { background: #16213e; padding: 25px; border: 2px solid #e94560; border-radius: 15px; width: 100%; max-width: 320px; text-align: center; }
        
        .setting { margin: 15px 0; text-align: left; }
        .setting label { font-size: 11px; color: #4ecca3; display: block; margin-bottom: 5px; }
        .val { float: right; color: #f9ca24; font-weight: bold; }
        
        input[type=range] { width: 100%; accent-color: #e94560; }
        #startBtn { 
            background: #e94560; color: white; border: none; padding: 15px; 
            width: 100%; font-size: 18px; font-weight: bold; border-radius: 8px; margin-top: 10px;
        }

        #joyBound { position: absolute; bottom: 30px; left: 30px; width: 100px; height: 100px; background: rgba(255,255,255,0.05); border-radius: 50%; border: 1px solid rgba(78, 204, 163, 0.2); display: none; }
        #joyStick { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; background: #4ecca3; border-radius: 50%; transform: translate(-50%, -50%); }

        #levelUp { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #16213e; padding: 20px; border: 2px solid #e94560; border-radius: 15px; display: none; z-index: 200; width: 80%; text-align: center; }
        .card { background: #0f3460; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #30475e; font-weight: bold; }
    </style>
</head>
<body>
    <div id="menu">
        <div class="menu-box">
            <h2 style="color: #e94560; margin: 0 0 20px 0;">NEON SURVIVOR</h2>
            <div class="setting">
                <label>XP MULT <span id="xpVal" class="val">x2</span></label>
                <input type="range" id="xpSlider" min="1" max="10" value="2">
            </div>
            <div class="setting">
                <label>SPAWN INTENSITY <span id="spawnVal" class="val">x1</span></label>
                <input type="range" id="spawnSlider" min="1" max="5" value="1" step="0.5">
            </div>
            <button id="startBtn">START MISSION</button>
        </div>
    </div>

    <div id="ui">
        <div class="stat">HP: <span id="hp">100</span> | LVL: <span id="lvl">1</span></div>
        <div class="stat">EXP: <span id="exp">0</span>/<span id="expNeeded">100</span></div>
    </div>

    <div id="joyBound"><div id="joyStick"></div></div>
    <div id="levelUp"><h3 style="color: #e94560">UPGRADE</h3><div id="options"></div></div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';

        const tg = window.Telegram.WebApp; tg.expand(); tg.ready();

        let audioCtx; 
        function playSfx(type) {
            if (!audioCtx || audioCtx.state === 'suspended') return;
            const o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.type = (type === 'explosion') ? 'sawtooth' : 'triangle';
            o.frequency.setValueAtTime(type === 'explosion' ? 100 : 600, audioCtx.currentTime);
            g.gain.setValueAtTime(0.05, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + 0.1);
        }

        const scene = new THREE.Scene(); scene.fog = new THREE.FogExp2(0x000000, 0.03);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true }); renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 0.6, 0.4, 0.85));
        composer.addPass(new OutputPass());

        scene.add(new THREE.GridHelper(1000, 80, 0x16213e, 0x050505));

        const game = { active: false, paused: false, xpMult: 2, spawnMult: 1 };
        const player = {
            group: new THREE.Group(),
            hp: 100, level: 1, exp: 0, expNeeded: 100, speed: 0.14, fireRate: 600, lastShot: 0, damage: 30
        };
        const pMesh = new THREE.Mesh(new THREE.ConeGeometry(0.5, 1.2, 4), new THREE.MeshStandardMaterial({ color: 0x4ecca3, emissive: 0x4ecca3, emissiveIntensity: 2 }));
        pMesh.rotation.x = Math.PI/2; player.group.add(pMesh); scene.add(player.group);
        const light = new THREE.PointLight(0x4ecca3, 40, 20); scene.add(light);

        let yaw = 0, pitch = 0.6;
        const enemies = [], bullets = [], orbs = [];

        // --- УПРАВЛЕНИЕ ---
        const xpS = document.getElementById('xpSlider'), spS = document.getElementById('spawnSlider');
        xpS.oninput = (e) => { game.xpMult = parseFloat(e.target.value); document.getElementById('xpVal').innerText = 'x'+game.xpMult; };
        spS.oninput = (e) => { game.spawnMult = parseFloat(e.target.value); document.getElementById('spawnVal').innerText = 'x'+game.spawnMult; };

        let joyPos = { x: 0, y: 0 }, tStart = { x: 0, y: 0 };
        document.addEventListener('touchstart', (e) => {
            if (!game.active || game.paused) return;
            const t = e.touches[0];
            if (t.clientX < window.innerWidth / 2) {
                document.getElementById('joyBound').style.display = 'block';
                document.getElementById('joyBound').style.left = (t.clientX - 50) + 'px';
                document.getElementById('joyBound').style.top = (t.clientY - 50) + 'px';
            }
            tStart = { x: t.clientX, y: t.clientY };
        });

        document.addEventListener('touchmove', (e) => {
            if (!game.active || game.paused) return;
            const t = e.touches[0];
            const dx = t.clientX - tStart.x, dy = t.clientY - tStart.y;
            if (t.clientX < window.innerWidth / 2) {
                const dist = Math.min(50, Math.sqrt(dx*dx + dy*dy));
                const ang = Math.atan2(dy, dx);
                joyPos = { x: Math.cos(ang) * (dist/50), y: Math.sin(ang) * (dist/50) };
                document.getElementById('joyStick').style.left = `calc(50% + ${joyPos.x * 35}px)`;
                document.getElementById('joyStick').style.top = `calc(50% + ${joyPos.y * 35}px)`;
            } else {
                yaw -= dx * 0.006; pitch = Math.max(-0.2, Math.min(1.1, pitch + dy * 0.006));
                tStart = { x: t.clientX, y: t.clientY };
            }
        });

        document.addEventListener('touchend', () => { 
            document.getElementById('joyBound').style.display = 'none'; 
            joyPos = { x: 0, y: 0 }; 
        });

        document.getElementById('startBtn').onclick = () => {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            audioCtx.resume().then(() => {
                game.active = true;
                document.getElementById('menu').style.display = 'none';
            });
        };

        function animate() {
            requestAnimationFrame(animate);
            if (game.active && !game.paused) {
                player.group.rotation.y = yaw;
                if (joyPos.x !== 0 || joyPos.y !== 0) {
                    const mv = new THREE.Vector3(joyPos.x, 0, joyPos.y).applyQuaternion(player.group.quaternion).multiplyScalar(player.speed);
                    player.group.position.add(mv);
                }

                if (Date.now() - player.lastShot > player.fireRate && enemies.length > 0) {
                    const b = new THREE.Mesh(new THREE.SphereGeometry(0.15), new THREE.MeshBasicMaterial({ color: 0xffffff }));
                    b.position.copy(player.group.position);
                    b.vel = new THREE.Vector3().subVectors(enemies[0].position, b.position).normalize().multiplyScalar(0.7);
                    scene.add(b); bullets.push(b); playSfx('shot'); player.lastShot = Date.now();
                }

                for(let i=bullets.length-1; i>=0; i--) {
                    bullets[i].position.add(bullets[i].vel);
                    if(bullets[i].position.distanceTo(player.group.position) > 40) { scene.remove(bullets[i]); bullets.splice(i, 1); continue; }
                    for(let j=enemies.length-1; j>=0; j--) {
                        if(bullets[i].position.distanceTo(enemies[j].position) < 1.3) {
                            enemies[j].hp -= player.damage;
                            if(enemies[j].hp <= 0) {
                                playSfx('explosion');
                                const o = new THREE.Mesh(new THREE.OctahedronGeometry(0.3), new THREE.MeshBasicMaterial({ color: 0xf9ca24 }));
                                o.position.copy(enemies[j].position); scene.add(o); orbs.push(o);
                                scene.remove(enemies[j]); enemies.splice(j, 1);
                            }
                            scene.remove(bullets[i]); bullets.splice(i, 1); break;
                        }
                    }
                }

                orbs.forEach((o, i) => {
                    if(o.position.distanceTo(player.group.position) < 8) {
                        o.position.lerp(player.group.position, 0.2);
                        if(o.position.distanceTo(player.group.position) < 1.1) {
                            player.exp += 20 * game.xpMult;
                            if(player.exp >= player.expNeeded) { 
                                game.paused = true; document.getElementById('levelUp').style.display = 'block';
                                const ops = document.getElementById('options'); ops.innerHTML = '';
                                ['Dmg+', 'Rate+'].forEach(t => {
                                    const c = document.createElement('div'); c.className = 'card'; c.innerText = t;
                                    c.onclick = () => { if(t.includes('Dmg')) player.damage += 15; else player.fireRate *= 0.85; document.getElementById('levelUp').style.display = 'none'; game.paused = false; };
                                    ops.appendChild(c);
                                });
                            }
                            scene.remove(o); orbs.splice(i, 1);
                        }
                    }
                });

                if(Math.random() < 0.01 * game.spawnMult) {
                    const a = Math.random()*Math.PI*2;
                    const e = new THREE.Mesh(new THREE.DodecahedronGeometry(0.6), new THREE.MeshStandardMaterial({ color: 0xe94560, emissive: 0xe94560 }));
                    e.position.set(player.group.position.x+Math.cos(a)*35, 0.6, player.group.position.z+Math.sin(a)*35);
                    e.hp = 30; scene.add(e); enemies.push(e);
                }
                enemies.forEach(e => e.position.add(new THREE.Vector3().subVectors(player.group.position, e.position).normalize().multiplyScalar(0.06)));
            }

            const camD = 10;
            camera.position.set(player.group.position.x + Math.sin(yaw)*camD*Math.cos(pitch), player.group.position.y + Math.sin(pitch)*camD + 4, player.group.position.z + Math.cos(yaw)*camD*Math.cos(pitch));
            camera.lookAt(player.group.position.clone().add(new THREE.Vector3(0, 1.5, 0)));
            light.position.copy(player.group.position).y = 3;
            document.getElementById('hp').innerText = Math.floor(player.hp);
            document.getElementById('lvl').innerText = player.level;
            composer.render();
        }
        animate();
    </script>
</body>
</html>
